<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mando Ahorcado</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #121212; color: white; text-align: center; margin: 0; }
        button { padding: 12px; margin: 4px; font-size: 16px; border-radius: 8px; border: none; font-weight: bold; }
        .btn-letra { width: 18%; background: #333; color: white; }
        .btn-letra:disabled { opacity: 0.2; }
        input { padding: 12px; width: 85%; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #222; color: white; text-align: center; }
        .setup-box { background: #1e1e1e; padding: 20px; border-radius: 15px; border-top: 5px solid #444; }
        .mi-equipo-tag { padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-bottom: 10px; display: inline-block; }
        .Wuachiturros { background: #00f2ff; color: #000; }
        .Chapisa { background: #ff00ff; color: #fff; }
        .puntos-mini { background: #000; padding: 10px; border-radius: 10px; font-size: 12px; display: flex; justify-content: space-around; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="pantalla-union" class="setup-box">
        <h2>ÚNETE A UN EQUIPO</h2>
        <select id="equipoSelect" style="padding: 12px; width: 100%; margin-bottom: 20px;">
            <option value="Wuachiturros">Wuachiturros</option>
            <option value="Chapisa">Chapisa</option>
        </select>
        <button onclick="unirse()" style="background: #fff; color: #000; width: 100%;">ENTRAR</button>
    </div>

    <div id="juego-container" style="display:none;">
        <div id="miTag" class="mi-equipo-tag"></div>
        <div class="puntos-mini">
            <span>W: <b id="pW">0</b></span> | <span>C: <b id="pC">0</b></span>
        </div>

        <div id="pantalla-capitan" class="setup-box" style="display:none;">
            <h3 id="rolTag" style="margin: 5px 0;">CAPITÁN</h3>
            <p id="instruccionCapitan" style="font-size: 14px;"></p>
            <input type="text" id="palabraInput" placeholder="PALABRA SECRETA">
            <input type="number" id="vidasInput" value="6">
            <button id="btn-iniciar" onclick="enviar()" style="background: #00ff00; color: #000; width: 100%;">ENVIAR PALABRA</button>
        </div>

        <div id="pantalla-juego" style="display:none;">
            <div id="infoTurno" style="padding: 10px; border-radius: 10px;"></div>
            <div id="teclado" style="margin-top: 15px;"></div>
            <button id="btn-next" onclick="socket.emit('nextRound')" style="display:none; background: #28a745; color: white; width: 100%; margin-top: 20px;">PRÓXIMA RONDA</button>
        </div>
    </div>

    <script>
        const socket = io();
        let miEquipo = "", miRol = "", lastErr = 0;

        function unirse() {
            miEquipo = document.getElementById('equipoSelect').value;
            socket.emit('setRole', miEquipo);
            document.getElementById('pantalla-union').style.display = 'none';
            document.getElementById('juego-container').style.display = 'block';
            const tag = document.getElementById('miTag');
            tag.innerText = "ESTÁS EN: " + miEquipo;
            tag.className = "mi-equipo-tag " + miEquipo;
        }

        socket.on('roleAssign', (data) => {
            miRol = data.role;
            if (miRol === 'capitan') document.getElementById('pantalla-capitan').style.display = 'block';
            else document.getElementById('pantalla-juego').style.display = 'block';
        });

        function enviar() {
            const p = document.getElementById('palabraInput').value;
            const v = document.getElementById('vidasInput').value;
            if(p) socket.emit('startGame', { palabra: p, vidas: v, equipo: miEquipo });
        }

        const divT = document.getElementById('teclado');
        "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ".split('').forEach(l => {
            const b = document.createElement('button');
            b.innerText = l; b.className = 'btn-letra';
            b.onclick = () => socket.emit('intentarLetra', { letra: l, equipo: miEquipo });
            divT.appendChild(b);
        });

        socket.on('updateState', (state) => {
            document.getElementById('pW').innerText = state.puntos.Wuachiturros.adivinadas;
            document.getElementById('pC').innerText = state.puntos.Chapisa.adivinadas;

            if (state.estado === "SETUP") {
                document.getElementById('pantalla-juego').style.display = 'none';
                if(miRol === 'capitan') {
                    document.getElementById('pantalla-capitan').style.display = 'block';
                    const miT = (miEquipo === state.equipoQuePonePalabra);
                    document.getElementById('btn-iniciar').disabled = !miT;
                    document.getElementById('btn-iniciar').style.opacity = miT ? "1" : "0.3";
                    document.getElementById('instruccionCapitan').innerText = miT ? "Escribe la palabra para el rival:" : "El rival está eligiendo...";
                    document.getElementById('palabraInput').value = "";
                } else {
                    document.getElementById('pantalla-juego').style.display = 'block';
                    document.getElementById('infoTurno').innerText = "EL OTRO EQUIPO ESTÁ ELIGIENDO PALABRA...";
                    document.getElementById('teclado').style.display = "none";
                }
                return;
            }

            document.getElementById('pantalla-capitan').style.display = 'none';
            document.getElementById('pantalla-juego').style.display = 'block';
            document.getElementById('teclado').style.display = "block";
            
            const esMiT = state.turno === miEquipo;
            const terminado = state.estado.startsWith("GANO") || state.estado.startsWith("PERDIO");
            const info = document.getElementById('infoTurno');

            if (!terminado) {
                info.innerText = esMiT ? "¡TU EQUIPO ADIVINA!" : "EL RIVAL ESTÁ ADIVINANDO...";
                info.style.background = esMiT ? "#00ff0033" : "#ff000033";
                document.getElementById('btn-next').style.display = 'none';
            } else {
                info.innerText = "RONDA TERMINADA";
                info.style.background = "#333";
                if (miRol === 'capitan') document.getElementById('btn-next').style.display = 'block';
            }
            
            if (state.errores > lastErr && esMiT && navigator.vibrate) navigator.vibrate(200);
            lastErr = state.errores;

            document.querySelectorAll('.btn-letra').forEach(b => {
                b.disabled = !esMiT || state.letrasAdivinadas.includes(b.innerText) || terminado;
            });
        });
    </script>
</body>
</html>
